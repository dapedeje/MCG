---
title: "Ruben"
output: html_document
date: "2025-04-30"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())#Esto para borrar las variables anteriores
packages = c("DBI","odbc","tidyverse","readxl","scales")
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,
                     repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})
```




```{r}
con <- dbConnect(odbc(),
                 Driver   = "ODBC Driver 17 for SQL Server",  
                 Server   = "localhost",
                 Database = "AdventureWorks2016_EXT",
                 Trusted_Connection = "Yes")
```

```{r}
Tablas_T <- dbListTables(con)

Tabla_comp <- Tablas_T[startsWith(Tablas_T,"Purchase")]
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ProductVendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ShipMethod"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "Vendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[startsWith(Tablas_T,"vVendorWith")])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "PurchaseOrderDetail"])
Tabla_comp
```

```{r}
lista_tablas <- list()
for(i in 1:length(Tabla_comp)){
  consulta <- paste0("SELECT * FROM Purchasing.",Tabla_comp[i])
  lista_tablas[[Tabla_comp[i]]] <- dbGetQuery(con, consulta)
}
```

```{r}
tablas_noPur <- c("HumanResources.Employee","Production.Product", "Production.UnitMeasure", "Person.BusinessEntity")

for(i in 1:length(tablas_noPur)){
  consulta <- paste0("SELECT * FROM ",tablas_noPur[i])
  lista_tablas[[tablas_noPur[i]]] <- dbGetQuery(con, consulta)
}
```

```{r, warning=FALSE}
Calendario <- read_excel("Calendario.xlsx", 
    col_types = c("numeric", "date", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "text", "text", "text", "date", 
        "date", "date", "date", "date", "date", 
        "date", "date", "numeric", "date", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text"))
```




```{r}
library(dplyr)
library(ggplot2)

detalle <- lista_tablas$PurchaseOrderDetail
proveedor <- lista_tablas$ProductVendor
producto <- lista_tablas$`Production.Product`
cabecera <- lista_tablas$PurchaseOrderHeader
nombreproveedor<-lista_tablas$Vendor

```

```{r}
library(forcats)
```


```{r}
compras_proveedor_anual <- detalle %>%
  inner_join(cabecera, by = "PurchaseOrderID") %>%
  inner_join(Calendario, by = c("OrderDate" = "Fecha")) %>%  # Join con calendario
  inner_join(nombreproveedor, by = c("VendorID" = "BusinessEntityID")) %>%
  group_by(Año, Name) %>%
  summarise(TotalComprado = sum(LineTotal, na.rm = TRUE), .groups = "drop") %>%
  group_by(Año) %>%
  slice_max(order_by = TotalComprado, n = 10)  # Top 10 por año



ggplot(compras_proveedor_anual, aes(
  x = TotalComprado,
  y = fct_reorder2(Name, Año, TotalComprado)
)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  facet_wrap(~ Año, scales = "free_y") +
  labs(
    title = "Top 10 proveedores con mayor volumen de compras por año",
    x = "Total comprado (Dólares en millones)",
    y = "Proveedor"
  ) +
  scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
  theme_minimal()
```




```{r}

compras_proveedor_anual$Año <- as.numeric(compras_proveedor_anual$Año)


anios <- sort(unique(compras_proveedor_anual$Año))


graficar_por_anio <- function(data, anio) {
  ggplot(filter(data, Año == anio),
         aes(x = TotalComprado, y = reorder(Name, TotalComprado))) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(
      title = paste("Top 10 proveedores en", anio),
      x = "Total comprado (Dólares en millones)",
      y = "Proveedor"
    ) +
    scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
    theme_minimal()
}


grafico_2011 <- graficar_por_anio(compras_proveedor_anual, 2011)
grafico_2012 <- graficar_por_anio(compras_proveedor_anual, 2012)
grafico_2013 <- graficar_por_anio(compras_proveedor_anual, 2013)
grafico_2014 <- graficar_por_anio(compras_proveedor_anual, 2014)

grafico_2011
grafico_2012
grafico_2013
grafico_2014
```

```{r}
top3_nombres <- compras_proveedor_anual %>%
  filter(Name %in% c("Chicago City Saddles", 
                     "Superior Bicycles", 
                     "Professional Athletic Consultants"))

totales_anuales <- compras_proveedor_anual %>%
  group_by(Año) %>%
  summarise(TotalAnual = sum(TotalComprado), .groups = "drop")

top3_indices <- top3_nombres %>%
  left_join(totales_anuales, by = "Año") %>%
  arrange(Name, Año) %>%
  group_by(Name) %>%
  mutate(
    Participacion = TotalComprado / TotalAnual * 100,
    GastoAnterior = lag(TotalComprado),
    TasaCrecimiento = (TotalComprado - GastoAnterior) / GastoAnterior * 100,
    Base = first(TotalComprado),
    IndiceBase100 = TotalComprado / Base * 100
  ) %>%
  ungroup() %>%

  select(Año,Name,TotalAnual, Participacion, TasaCrecimiento,IndiceBase100)
```

```{r}
top3_indices
```


Indicador 2 Comparacion de precios de los precios estandar (precio esperado) con el precio real 




```{r}
comparacion_precios_anual <- detalle %>%
  inner_join(cabecera, by = "PurchaseOrderID") %>%
  inner_join(proveedor, by = "ProductID") %>%
  inner_join(producto, by = "ProductID") %>%
  inner_join(Calendario, by = c("OrderDate" = "Fecha")) %>%
  select(Año, ProductID, ProductName = Name, PrecioReal = UnitPrice, PrecioEstandar = StandardPrice) %>%
  mutate(Diferencia = PrecioReal - PrecioEstandar) %>%
  filter(!is.na(Año)) %>%
  group_by(Año, ProductID, ProductName) %>%
  summarise(DiferenciaPromedio = mean(Diferencia, na.rm = TRUE), .groups = "drop") %>%
  arrange(Año, desc(DiferenciaPromedio))
```

```{r}

top_altas_anual <- comparacion_precios_anual %>%
  group_by(Año) %>%
  slice_max(order_by = DiferenciaPromedio, n = 10) %>%
  ungroup()

top_bajas_anual <- comparacion_precios_anual %>%
  group_by(Año) %>%
  slice_min(order_by = DiferenciaPromedio, n = 10) %>%
  ungroup()
```

```{r}

ggplot(top_altas_anual, aes(x = reorder(ProductName, DiferenciaPromedio), y = DiferenciaPromedio)) +
  geom_bar(stat = "identity", fill = "darkred") +
  facet_wrap(~ Año, scales = "free_y") +
  labs(
    title = "Top Productos con precio real muy Superior al estándar por año",
    x = "Producto",
    y = "Diferencia Promedio"
  ) +
  coord_flip() +
  theme_minimal()

ggplot(top_bajas_anual, aes(x = reorder(ProductName, DiferenciaPromedio), y = DiferenciaPromedio)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  facet_wrap(~ Año, scales = "free_y") +
  labs(
    title = "Top Productos con precio real muy inferior al estándar por año",
    x = "Producto",
    y = "Diferencia Promedio"
  ) +
  coord_flip() +
  theme_minimal()
```




La unica conclusion que podemos sacar es que respecto a esto es que tanto como los pedales como los frenos los estamos comprando todos los años a un precio mayor del esperado, esto puede deberse a que el precio esperado esta mal calculado o estamos pagando mas de lo que deberiamos en estas compras. Tambien que en el ultimo año es cuando hay mas cambios entre los precios esperado y los precios reales   

