---
title: "Cosas"
author: "David Alejandro Pedroza De Jesús"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  pdf_document: 
    toc: TRUE 
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
lang: es
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Cargamos las librerías necesarias y borramos las variables anteriores:

```{r results='hide', warning=FALSE}
rm(list=ls())#Esto para borrar las variables anteriores
packages = c("DBI","odbc","tidyverse","readxl")
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,
                     repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})
```

hacemos una conexión con nuestra base de datos.

```{r}
con <- dbConnect(odbc(),
                 Driver   = "ODBC Driver 17 for SQL Server",  
                 Server   = "DAVID",
                 Database = "AdventureWorks2016_EXT",
                 Trusted_Connection = "Yes")
```

Buscamos las tablas del esquema que coinciden con nuestra base de datos

```{r}
Tablas_T <- dbListTables(con)

Tabla_comp <- Tablas_T[startsWith(Tablas_T,"Purchase")]
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ProductVendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ShipMethod"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "Vendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[startsWith(Tablas_T,"vVendorWith")])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "PurchaseOrderDetail"])
Tabla_comp
```

```{r}
lista_tablas <- list()
for(i in 1:length(Tabla_comp)){
  consulta <- paste0("SELECT * FROM Purchasing.",Tabla_comp[i])
  lista_tablas[[Tabla_comp[i]]] <- dbGetQuery(con, consulta)
}
```

```{r}
tablas_noPur <- c("HumanResources.Employee","Production.Product", "Production.UnitMeasure", "Person.BusinessEntity")

for(i in 1:length(tablas_noPur)){
  consulta <- paste0("SELECT * FROM ",tablas_noPur[i])
  lista_tablas[[tablas_noPur[i]]] <- dbGetQuery(con, consulta)
}
```


```{r, warning=FALSE}
Calendario <- read_excel("Calendario.xlsx", 
    col_types = c("numeric", "date", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "text", "text", "text", "date", 
        "date", "date", "date", "date", "date", 
        "date", "date", "numeric", "date", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text"))
```


# Producto más comprado.

```{r}
TablaHechosDetalle <- lista_tablas$PurchaseOrderDetail
TablaProducto <- lista_tablas$Production.Product
```

Los 10 productos más vendidos.

```{r}
Top10 <-  TablaHechos %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10)
Top10

```


Ventas de los productos:

```{r}
Top10 %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```



# Compras en funcion del dia.

```{r}
TablaDeHechos <- lista_tablas$PurchaseOrderHeader

TablaCompDias <- TablaDeHechos %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  select(PurchaseOrderID, "Dia Semana","Dia Semana Num") %>%
  rename("Dia" = "Dia Semana", "DiaNum" = "Dia Semana Num") %>%
  group_by(Dia,DiaNum) %>%
  summarise("TotalOrdenes" = n()) %>%
  arrange(DiaNum)

TablaCompDias %>% select(Dia,TotalOrdenes)
```


```{r}
TablaCompDias %>%
  ggplot(aes(y = TotalOrdenes, x = factor(DiaNum))) +
  geom_bar(stat = "identity", fill = "lightblue") +
  scale_x_discrete(labels = c("7" = "Domingo", "6" = "Sabado", "5" = "Viernes",
                              "4" = "Jueves", "3" = "Miercoles", "2" = "Martes",
                              "1" = "Lunes")) + 
  ggtitle("Cantidad de ordenes por día") +
  xlab("Día") + 
  ylab("Total de ordenes")
```
Del día más con más ordenes veamos que productos son los más ordenados.


```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "miércoles") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día miércoles)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```
Es curioso que el producto con más ordenes el miércoles, sería interesante, sería interesante ver que es lo que se vende en cada día:

```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "domingo") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día domingo)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```

```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "lunes") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día lunes)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```
```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "martes") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día martes)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```

```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "jueves") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día jueves)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```
```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "viernes") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día viernes)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```

```{r}
lista_tablas$PurchaseOrderHeader %>%
  inner_join(Calendario, by = join_by(OrderDate == Fecha)) %>%
  rename("DiaSem" = "Dia Semana" ) %>%
  filter(DiaSem == "sábado") %>%
  inner_join(TablaHechosDetalle, by = "PurchaseOrderID") %>%
  select(PurchaseOrderID, ProductID) %>%
  inner_join(TablaProducto, by = "ProductID") %>%
  select(Name) %>%
  group_by(Name) %>%
  summarise("Total" = n()) %>%
  arrange(desc(Total)) %>%
  head(10) %>%
  ggplot(aes(x = Total, y = Name)) +
  geom_bar(stat = "identity", fill = "lightblue") + 
  ggtitle("Cantidad de ordenes por producto(Día sábado)") +
  xlab("Numero de ordenes") + 
  ylab("Nombre del producto")
```



