---
title: "Cosas"
author: "Joel"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  pdf_document: 
    toc: TRUE 
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
lang: es
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Cargamos las librerías necesarias y borramos las variables anteriores:

```{r results='hide', warning=FALSE}
rm(list=ls())#Esto para borrar las variables anteriores
packages = c("DBI","odbc","tidyverse","readxl","dplyr","ggplot2","lubridate")
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,
                     repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})
```

hacemos una conexión con nuestra base de datos.

```{r}
con <- dbConnect(odbc(),
                 Driver   = "ODBC Driver 17 for SQL Server",  
                 Server   = "LAPTOP-VJGSMCQF\\JOEL_BISS",
                 Database = "AdventureWorks2016_EXT",
                 Trusted_Connection = "Yes")
```

Buscamos las tablas del esquema que coinciden con nuestra base de datos

```{r}
Tablas_T <- dbListTables(con)

Tabla_comp <- Tablas_T[startsWith(Tablas_T,"Purchase")]
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ProductVendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ShipMethod"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "Vendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[startsWith(Tablas_T,"vVendorWith")])
Tabla_comp
```

```{r}
lista_tablas <- list()
for(i in 1:length(Tabla_comp)){
  consulta <- paste0("SELECT * FROM Purchasing.",Tabla_comp[i])
  lista_tablas[[Tabla_comp[i]]] <- dbGetQuery(con, consulta)
}
```

```{r}
tablas_noPur <- c("HumanResources.Employee","Production.Product", "Production.UnitMeasure", "Person.BusinessEntity")

for(i in 1:length(tablas_noPur)){
  consulta <- paste0("SELECT * FROM ",tablas_noPur[i])
  lista_tablas[[tablas_noPur[i]]] <- dbGetQuery(con, consulta)
}
```

```{r, warning=FALSE}
Calendario <- read_excel("Calendario.xlsx", 
    col_types = c("numeric", "date", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "text", "text", "text", "date", 
        "date", "date", "date", "date", "date", 
        "date", "date", "numeric", "date", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text"))
```

```{r}
head(Calendario)
```



```{r}
# Lista de nombres de tablas que quieres explorar
tablas_interes <- c(
  "PurchaseOrderDetail",
  "PurchaseOrderHeader",
  "ProductVendor",
  "ShipMethod",
  "Vendor",
  "vVendorWithAddresses",
  "vVendorWithContacts",
  "HumanResources.Employee",
  "Production.Product",
  "Production.UnitMeasure",
  "Person.BusinessEntity"
)

# Mostrar los nombres de todas las tablas disponibles
cat("------------------------------\n")
cat("**lista_names**\n")
print(names(lista_tablas))

# Mostrar los nombres de las columnas de cada tabla de interés
for (nombre_tabla in tablas_interes) {
  cat("------------------------------\n")
  cat(paste0("**", nombre_tabla, "**\n"))
  print(names(lista_tablas[[nombre_tabla]]))
}

```



```{r}
lista_tablas
print("Calendario")
names(Calendario)
```

```{r}
# Unimos encabezados de órdenes con calendario
compras <- lista_tablas$PurchaseOrderHeader %>%
  select(PurchaseOrderID, VendorID, OrderDate, TotalDue) %>%
  inner_join(Calendario, by = c("OrderDate" = "Fecha"))

```


2. Evolución de las compras en el tiempo
a. Evolución mensual:


```{r}
evolucion_mensual <- compras %>%
  group_by(`Año`, `Mes Num`, `Mes Largo - Año`) %>%
  summarise(Total = sum(TotalDue), .groups = "drop") %>%
  arrange(Año, `Mes Num`) %>%
  mutate(MesOrdenado = factor(`Mes Largo - Año`, levels = unique(`Mes Largo - Año`)))

ggplot(evolucion_mensual, aes(x = MesOrdenado, y = Total)) +
  geom_col(fill = "steelblue") +
  labs(title = "Evolución mensual del gasto en compras",
       x = "Mes",
       y = "Total de compras") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

```


b. Evolución trimestral:
```{r}

evolucion_trimestral <- compras %>%
  group_by(`Año`, `Trimestre Num`, `Trimestre`) %>%
  summarise(Total = sum(TotalDue), .groups = "drop") %>%
  arrange(Año, `Trimestre Num`) %>%
  mutate(TrimestreOrdenado = factor(paste(Trimestre, Año), 
                                    levels = unique(paste(Trimestre, Año))))


ggplot(evolucion_trimestral, aes(x = TrimestreOrdenado, y = Total)) +
  geom_col(fill = "darkgreen") +
  labs(title = "Evolución trimestral del gasto en compras",
       x = "Trimestre",
       y = "Total de compras") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}
evolucion_trimestral <- compras %>%
  group_by(`Trimestre`, `Año`) %>%
  summarise(Total = sum(TotalDue), .groups = "drop") %>%
  arrange(Año, Trimestre) %>%
  mutate(Periodo = paste0("T", Trimestre, "-", Año),
         Periodo = factor(Periodo, levels = unique(Periodo)))

ggplot(evolucion_trimestral, aes(x = Periodo, y = Total)) +
  geom_line(group = 1, color = "darkred") +
  geom_point(color = "red") +
  labs(title = "Evolución trimestral de compras",
       x = "Trimestre",
       y = "Total de compras") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```

3. Frecuencia de órdenes por período
Podemos también analizar cuántas órdenes se emiten por mes, no solo el total económico:

```{r}
frecuencia_mensual <- compras %>%
  group_by(`Mes Largo - Año`, `Año`, `Mes Num`) %>%
  summarise(Ordenes = n(), .groups = "drop") %>%
  arrange(Año, `Mes Num`) %>%
  mutate(`Mes Largo - Año` = factor(`Mes Largo - Año`, levels = unique(`Mes Largo - Año`)))

ggplot(frecuencia_mensual, aes(x = `Mes Largo - Año`, y = Ordenes)) +
  geom_col(fill = "darkgreen") +
  labs(title = "Cantidad de órdenes emitidas por mes",
       x = "Mes",
       y = "Número de órdenes") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))


```



4. Proveedores más importantes por monto total

```{r}
top_proveedores <- compras %>%
  inner_join(lista_tablas$Vendor, by = c("VendorID" = "BusinessEntityID")) %>%
  group_by(Name) %>%
  summarise(TotalComprado = sum(TotalDue)) %>%
  arrange(desc(TotalComprado)) %>%
  head(10)

ggplot(top_proveedores, aes(x = reorder(Name, TotalComprado), y = TotalComprado)) +
  geom_col(fill = "orange") +
  coord_flip() +
  labs(title = "Top 10 proveedores por volumen de compras",
       x = "Proveedor",
       y = "Total comprado")

```

Podrias cojer los top 3 y desplegar para ver cuales son los productos que venden ordenados de más vendido a menos.


Tambien quiero un ranking pero en vez de por volumen por cantidad de dinero ganada

```{r}
library(dplyr)

# Obtener ID del vendor "Superior Bicycles"
vendor_id <- lista_tablas$Vendor %>%
  filter(Name == "Superior Bicycles") %>%
  pull(BusinessEntityID)

# Filtrar productos asociados a ese vendor
productos_superior <- lista_tablas$ProductVendor %>%
  filter(BusinessEntityID == vendor_id) %>%
  inner_join(lista_tablas$Production.Product, by = "ProductID") %>%
  select(ProductID, ProductName = Name, ProductNumber, StandardPrice, UnitMeasureCode)

# Mostrar resultado
print(productos_superior)

```



```{r}
# Top 3 proveedores por total comprado (AUN NO FUNCIONA!!)
top3_proveedores <- compras %>%
  inner_join(lista_tablas$Vendor, by = c("VendorID" = "BusinessEntityID")) %>%
  group_by(VendorID, Proveedor = Name) %>%
  summarise(TotalComprado = sum(TotalDue), .groups = "drop") %>%
  arrange(desc(TotalComprado)) %>%
  slice_head(n = 3)


compras

lista_tablas$Production.Product
productos_top3 <- compras %>%
  filter(VendorID %in% top3_proveedores$VendorID) %>%
  left_join(lista_tablas$PurchaseOrderDetail , by = c("PurchaseOrderID" = "PurchaseOrderID")) %>%
  inner_join(lista_tablas$Vendor, by = c("VendorID" = "BusinessEntityID")) %>%
  group_by(Name, ProductID) %>% 
  summarise(TotalComprado = sum(TotalDue)) %>%
  arrange(Name, desc(TotalComprado))
productos_top3



productos_top3 <- productos_top3 %>%
  left_join(lista_tablas$Production.Product %>% select(ProductID, ProductName = Name),
            by = "ProductID")

# Crear gráfico con nombres de producto
ggplot(productos_top3, aes(x = reorder(ProductName, TotalComprado), y = TotalComprado, fill = Name)) +
  geom_col(show.legend = TRUE) +
  facet_wrap(~ Name, scales = "free_y") +
  coord_flip() +
  labs(title = "Productos más comprados a los Top 3 proveedores",
       x = "Producto",
       y = "Total comprado (€)",
       fill = "Proveedor")

```





```{r}
ranking_monto <- compras %>%
  inner_join(lista_tablas$Vendor, by = c("VendorID" = "BusinessEntityID")) %>%
  group_by(Name) %>%
  summarise(TotalGanado = sum(TotalDue), .groups = "drop") %>%
  arrange(desc(TotalGanado))

ggplot(ranking_monto[1:10, ], aes(x = reorder(Name, TotalGanado), y = TotalGanado)) +
  geom_col(fill = "darkblue") +
  coord_flip() +
  labs(title = "Top 10 proveedores por dinero ganado",
       x = "Proveedor",
       y = "Total ganado")

```














































Ignora esto de abajo!!



```{r}
library(dplyr)
library(lubridate)

# Unir detalle y cabecera
compras <- lista_tablas$PurchaseOrderDetail %>%
  inner_join(lista_tablas$PurchaseOrderHeader, by = "PurchaseOrderID") %>%
  mutate(Mes = floor_date(OrderDate, "month"))

# Agregar nombre del producto
compras <- compras %>%
  left_join(lista_tablas$`Production.Product`, by = "ProductID")

# Agregado por producto y mes
precios_mensuales <- compras %>%
  group_by(Mes, ProductID, Name) %>%
  summarise(Precio = mean(UnitPrice), Cantidad = sum(OrderQty), .groups = "drop")


```



```{r}
# Selecciona meses base y comparación

fecha <- "2012-01-01"
mes_base <- as.POSIXct(fecha, format = "%Y-%m-%d", tz = "UTC")
fecha <- "2012-02-01"
mes_comp <- as.POSIXct(fecha, format = "%Y-%m-%d", tz = "UTC")
class(mes_base)
mes_base
precios_mensuales$Mes[1]
View(precios_mensuales)
base <- precios_mensuales %>% filter(Mes == mes_base)
comp <- precios_mensuales %>% filter(Mes == mes_comp)

indice_laspeyres <- comp %>%
  inner_join(base, by = "ProductID", suffix = c("_comp", "_base")) %>%
  summarise(
    L = sum(Precio_comp * Cantidad_base) / sum(Precio_base * Cantidad_base)
  )

base

```




```{r}
indice_paasche <- comp %>%
  inner_join(base, by = "ProductID", suffix = c("_comp", "_base")) %>%
  summarise(
    P = sum(Precio_comp * Cantidad_comp) / sum(Precio_base * Cantidad_comp)
  )

indice_fisher <- tibble(
  Fisher = sqrt(indice_laspeyres$L * indice_paasche$P)
)

```




```{r}
# Gasto por proveedor
gastos_proveedor <- compras %>%
  group_by(VendorID) %>%
  summarise(Gasto = sum(LineTotal), .groups = "drop") %>%
  arrange(Gasto) %>%
  mutate(
    PropGasto = Gasto / sum(Gasto),
    Acumulado = cumsum(PropGasto),
    i = row_number(),
    xi = i / n()
  )

# Cálculo del índice de Gini
gini <- 1 - sum((gastos_proveedor$Acumulado + lag(gastos_proveedor$Acumulado, default = 0)) * diff(c(0, gastos_proveedor$xi)))

```


```{r}
gini
indice_fisher
indice_laspeyres
indice_paasche
```



Paasche índices comparan la evolución de precios entre dos períodos.

Incluir índice de Gini anual o trimestral → para comentar si estás dependiendo de pocos proveedores (riesgo).

Segmentar por categoría de producto (Production.Product$ProductLine) → para ver si los precios suben más en una línea.



```{r}
library(dplyr)
library(tidyr)
library(lubridate)

# Une detalle con cabecera y producto
compras <- lista_tablas$PurchaseOrderDetail %>%
  inner_join(lista_tablas$PurchaseOrderHeader, by = "PurchaseOrderID") %>%
  inner_join(lista_tablas$Production.Product, by = "ProductID") %>%
  mutate(Mes = floor_date(OrderDate, "month"))

# Resumen mensual por producto
precios_mensuales <- compras %>%
  group_by(Mes, ProductID, Name) %>%
  summarise(
    PrecioUnitario = mean(UnitPrice),
    CantidadComprada = sum(OrderQty),
    .groups = "drop"
  )

```


```{r}
# Mes base
mes_base <- min(precios_mensuales$Mes)

# Datos del mes base
base <- precios_mensuales %>% filter(Mes == mes_base) %>%
  select(ProductID, CantidadBase = CantidadComprada)

# Cálculo del índice de Laspeyres
indice_laspeyres <- precios_mensuales %>%
  inner_join(base, by = "ProductID") %>%
  group_by(Mes) %>%
  summarise(
    Laspeyres = sum(PrecioUnitario * CantidadBase) / sum(base$PrecioUnitario * base$CantidadBase)
  )

```

```{r}
# Agrega precios base
precios_base <- precios_mensuales %>% filter(Mes == mes_base) %>%
  select(ProductID, PrecioBase = PrecioUnitario)

# Índice de Paasche
indice_paasche <- precios_mensuales %>%
  inner_join(precios_base, by = "ProductID") %>%
  group_by(Mes) %>%
  summarise(
    Paasche = sum(PrecioUnitario * CantidadComprada) / sum(PrecioBase * CantidadComprada)
  )

```


```{r}
indice_fisher <- inner_join(indice_laspeyres, indice_paasche, by = "Mes") %>%
  mutate(Fisher = sqrt(Laspeyres * Paasche))

```


```{r}
library(DescTools)

indice_gini <- precios_mensuales %>%
  group_by(Mes) %>%
  summarise(Gini = Gini(PrecioUnitario))

```

```{r}
library(ggplot2)

# Unimos índices
indices <- reduce(list(indice_laspeyres, indice_paasche, indice_fisher), full_join, by = "Mes")
names(indices)
# Plot
ggplot(indices, aes(x = Mes)) +
  geom_line(aes(y = Laspeyres.y, color = "Laspeyres")) +
  geom_line(aes(y = Paasche.y, color = "Paasche")) +
  geom_line(aes(y = Fisher, color = "Fisher")) +
  labs(title = "Evolución de los índices de precios",
       y = "Índice", x = "Mes", color = "Índice")

```


```{r}
ggplot(indice_gini, aes(x = Mes, y = Gini)) +
  geom_line(color = "darkred") +
  labs(title = "Índice de Gini por mes",
       y = "Gini (desigualdad de precios)",
       x = "Mes")

```

