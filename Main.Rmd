---
title: "Cosas"
author: "David Alejandro Pedroza De Jesús"
date: "`r format(Sys.Date(), '%d de %B de %Y')`"
output:
  pdf_document: 
    toc: TRUE 
  html_document:
    df_print: paged
editor_options: 
  markdown: 
    wrap: 72
lang: es
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Cargamos las librerías necesarias y borramos las variables anteriores:

```{r results='hide', warning=FALSE}
rm(list=ls())#Esto para borrar las variables anteriores
packages = c("DBI","odbc","tidyverse","readxl","scales")
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,
                     repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})
```

hacemos una conexión con nuestra base de datos.

```{r}
con <- dbConnect(odbc(),
                 Driver   = "ODBC Driver 17 for SQL Server",  
                 Server   = "localhost",
                 Database = "AdventureWorks2016_EXT",
                 Trusted_Connection = "Yes")
```

Buscamos las tablas del esquema que coinciden con nuestra base de datos

```{r}
Tablas_T <- dbListTables(con)

Tabla_comp <- Tablas_T[startsWith(Tablas_T,"Purchase")]
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ProductVendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "ShipMethod"])
Tabla_comp <- c(Tabla_comp, Tablas_T[Tablas_T == "Vendor"])
Tabla_comp <- c(Tabla_comp, Tablas_T[startsWith(Tablas_T,"vVendorWith")])
Tabla_comp
```

```{r}
lista_tablas <- list()
for(i in 1:length(Tabla_comp)){
  consulta <- paste0("SELECT * FROM Purchasing.",Tabla_comp[i])
  lista_tablas[[Tabla_comp[i]]] <- dbGetQuery(con, consulta)
}
```

```{r}
tablas_noPur <- c("HumanResources.Employee","Production.Product", "Production.UnitMeasure", "Person.BusinessEntity")

for(i in 1:length(tablas_noPur)){
  consulta <- paste0("SELECT * FROM ",tablas_noPur[i])
  lista_tablas[[tablas_noPur[i]]] <- dbGetQuery(con, consulta)
}
```

```{r, warning=FALSE}
Calendario <- read_excel("Calendario.xlsx", 
    col_types = c("numeric", "date", "numeric", 
        "numeric", "numeric", "numeric", 
        "text", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "text", "text", "text", 
        "text", "text", "text", "text", "date", 
        "date", "date", "date", "date", "date", 
        "date", "date", "numeric", "date", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric", "text", "text"))
```

```{r}
head(Calendario)
```










#Ranking de metodos de envio mas usados


```{r}
metodos<-lista_tablas$ShipMethod
header<- lista_tablas$PurchaseOrderHeader 

ranking <- metodos %>%
  inner_join(header, by = "ShipMethodID") %>%
  select(Name, ) %>% 
  group_by(Name) %>%
  summarise(Total = n())%>%
  arrange(desc(Total))%>%
  mutate(pctj=round((Total/sum(Total))*100,2))


ranking
```

#Indice Gini
```{r}
c1 <- rev(ranking$Total)
c2 <- c1 / sum(c1)
 
x <- c(0, seq(0.20, 1, 0.20))  
y <- c(0, cumsum(c2))          
 
area <- sum((y[-1] + y[-length(y)]) * diff(x))  
gini <- 1 - area
 
print(gini)
```

El indice de Gini muestra una desigualdad moderada entre el numero de envios que se realiza con cada metodo, como se puede ver en el grafico de despues.

#Grafico

```{r} 


library(ggplot2) 


ggplot(ranking, aes(x = reorder(Name, Total), y = Total, fill = Name)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = Total), hjust = -0.1, size = 4) +  # etiquetas al final de la barra
  coord_flip() +
  labs(
    title = "Ranking de métodos de envío más usados",
    x = "Método de envío",
    y = "Número total de envíos"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 1),
    legend.position = "none"
  ) +
  scale_fill_brewer(palette = "Dark2") +
  expand_limits(y = max(ranking$Total) * 1.1)

 


```
 
Mas del 60% de envios son realizados mediante dos metodos, mientras que OVERSEAS DELUXE unicamente realiza el 4%, hay cierta desigualdad entre los metodos de envio usados como se muestra con el indice de Gini (0.3212363)



#Precio total de las tarifas de cada metodo


```{r}
Promedio_tarifas <-  metodos %>%  
  group_by(Name)%>%
  summarise("Promedio" = mean(ShipBase + ShipRate))%>%
  select(Name, Promedio)%>%
  arrange(desc(Promedio))

Promedio_tarifas
```



#Indice Gini
```{r}
c1 <- rev(Promedio_tarifas$Promedio)
c2 <- c1 / sum(c1)
 
x <- c(0, seq(0.20, 1, 0.20))  
y <- c(0, cumsum(c2))          
 
area <- sum((y[-1] + y[-length(y)]) * diff(x))  
gini <- 1 - area
 
print(gini)
```


```{r}
ggplot(Promedio_tarifas, aes(x = reorder(Name, Promedio), y = Promedio, fill = Name)) +
  geom_bar(stat = "identity", color = "black") +
  geom_text(aes(label = Promedio), hjust = -0.1, size = 4) +  # etiquetas al final de la barra
  coord_flip() +
  labs(
    title = "Ranking de tarifas mas caras",
    x = "Método de envío",
    y = "Precio tarifa"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.y = element_blank(),
    axis.text.y = element_text(hjust = 1),
    legend.position = "none"
  ) +
  scale_fill_brewer(palette = "Dark2") +
  expand_limits(y = max(Promedio_tarifas$Promedio) * 1.1)

```
En este análisis, se observa que el método "OVERSEAS - DELUXE" tiene las tarifas más altas con diferencia. Esta puede ser debido a que, como su nombre indica, ofrece un servicio de envío de lujo, lo cual tambien justifica que sea el metodo que menos envios realiza con diferencia. 

Es curioso el caso de XRQ TRUCK GROUND ya que es el metodo con tarifas mas baratas con diferencia y quitando a OVERSEAS - DELUXE es el que menos envios realiza, probablemente se trate de una empresa pequeña o que este empezando, bajando sus tarifas para obtener una mejor posicion en el mercado.




#Promedio tiempo de entrega de cada grafico

```{r}
Promedio_tiempo<-metodos %>%  
  inner_join(header, by = "ShipMethodID")%>%
  mutate(
    ShipDate = as.Date(ShipDate),   
    OrderDate = as.Date(OrderDate)   
  ) %>%
  
  group_by(Name)%>%
  summarise("Promedio"=mean(ShipDate-OrderDate ))%>%
  select(Name,Promedio)
d<-header$ShipDate-header$OrderDate  
unique(d)
sum(d==25)
sum(d==9)
length(d)
Promedio_tiempo
```
Al calcular el promedio de los 4000 tiempos de envio se observa que todas las entregas son en nueve dias excepto 12, del metodo "OVERSEAS - DELUXE" que tardaron 25 dias, lo cual es extraño teniendo en cuenta que es el metodo mas caro. Esto probablemente sea un indicativo de un error al introducir los datos, o puede que no sean fechas reales y se hayan generado artificialmente.



 #Evolucion del numero de envios por metodo en funcion del tiempo


```{r}
library(lubridate)
EnviosTiempo<-metodos %>%  
  inner_join(header, by = "ShipMethodID") %>%
  mutate( "Fecha"= format(OrderDate, "%Y-%m"))%>%
  group_by(Fecha, Name)%>%
  summarise("Total" = n()) %>%
  arrange(Fecha,Name)%>%
  select(Fecha,Name,Total)
EnviosTiempo 
```


```{r}
library(ggplot2)
 
EnviosTiempo$Fecha <- as.Date(paste0(EnviosTiempo$Fecha, "-01"))
 
ggplot(EnviosTiempo, aes(x = Fecha, y = Total, color = Name)) +
  geom_line(size = 1.2) +
  labs(
    title = "Evolución temporal de los envíos por método",
    x = "Fecha",
    y = "Total de envíos",
    color = "Método de envío"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "left"
  )



```

 
Como se aprecia en la gráfica, a mediados de 2013 la cantidad de envíos se dispara y, a partir de ese momento, los métodos pueden agruparse en tres categorías:

Cargo Transport 5 y Overnight J-Fast: crecen de forma drástica, pasando de apenas 15 envíos al mes a más de 100.

XRQ – Truck Ground y ZY-Express: también experimentan un fuerte aumento, aunque más moderado, alcanzando unos 50 envíos mensuales.

Overseas – Deluxe: a diferencia del resto, su número de envíos apenas se incrementa.

Este repentino aumento podría explicarse por el auge del comercio electrónico en ese periodo o por una campaña concreta. Tras el pico, el volumen de envíos cae notablemente —tal vez por un fallo logístico— antes de retomar de nuevo su tendencia al alza. En 2014 vuelve a haber una bajada drastica por las mismas fechas, en verano, quizas las empresas bajan su produccion en esta epoca debido a la falta de demanda o de trabajadores.


#Indicador  Proveedores con mayor volumen de compra 


```{r}
library(dplyr)
library(ggplot2)

detalle <- lista_tablas$PurchaseOrderDetail
proveedor <- lista_tablas$ProductVendor
producto <- lista_tablas$`Production.Product`
cabecera <- lista_tablas$PurchaseOrderHeader
nombreproveedor<-lista_tablas$Vendor

```

```{r}
library(forcats)
```


```{r}
compras_proveedor_anual <- detalle %>%
  inner_join(cabecera, by = "PurchaseOrderID") %>%
  inner_join(Calendario, by = c("OrderDate" = "Fecha")) %>%  
  inner_join(nombreproveedor, by = c("VendorID" = "BusinessEntityID")) %>%
  group_by(Año, Name) %>%
  summarise(TotalComprado = sum(LineTotal, na.rm = TRUE), .groups = "drop") %>%
  group_by(Año) %>%
  slice_max(order_by = TotalComprado, n = 10)  
```



```{r}

compras_proveedor_anual$Año <- as.numeric(compras_proveedor_anual$Año)


anios <- sort(unique(compras_proveedor_anual$Año))


graficar_por_anio <- function(data, anio) {
  ggplot(filter(data, Año == anio),
         aes(x = TotalComprado, y = reorder(Name, TotalComprado))) +
    geom_bar(stat = "identity", fill = "steelblue") +
    labs(
      title = paste("Top 10 proveedores en", anio),
      x = "Total comprado (Dólares en millones)",
      y = "Proveedor"
    ) +
    scale_x_continuous(labels = label_number(scale_cut = cut_short_scale())) +
    theme_minimal()
}


grafico_2011 <- graficar_por_anio(compras_proveedor_anual, 2011)
grafico_2012 <- graficar_por_anio(compras_proveedor_anual, 2012)
grafico_2013 <- graficar_por_anio(compras_proveedor_anual, 2013)
grafico_2014 <- graficar_por_anio(compras_proveedor_anual, 2014)

grafico_2011
grafico_2012
grafico_2013
grafico_2014
```
En este apartado hemos calculado las compras realizadas a los  mayores proveedores por año, en el año 2014 solo tenemos datos hasta agosto , por lo que en los indices y tasas que saquemos tendremos que tener en cuenta este factor.

Podemos ver principalmente 3 proveedores que destacan mas respecto al resto, estos proveedores son
Chicago City Saddles (por destacar el primer año y mantenerse en lo alto) y luego tenemos Superior Bicycles y Professional Athletic Consultants (destacan mucho en los años posteriores)
Y esque estos 2 ultimos proveedores no estaban en 2011.


```{r}
top3_nombres <- compras_proveedor_anual %>%
  filter(Name %in% c("Chicago City Saddles", 
                     "Superior Bicycles", 
                     "Professional Athletic Consultants"))

totales_anuales <- compras_proveedor_anual %>%
  group_by(Año) %>%
  summarise(TotalAnual = sum(TotalComprado), .groups = "drop")

top3_indices <- top3_nombres %>%
  left_join(totales_anuales, by = "Año") %>%
  arrange(Name, Año) %>%
  group_by(Name) %>%
  mutate(
    Participacion = TotalComprado / TotalAnual * 100,
    GastoAnterior = lag(TotalComprado),
    TasaCrecimiento = (TotalComprado - GastoAnterior) / GastoAnterior * 100,
    Base = first(TotalComprado),
    IndiceBase100 = TotalComprado / Base * 100
  ) %>%
  ungroup() %>%

  select(Año,Name,TotalAnual, Participacion, TasaCrecimiento,IndiceBase100)
```

```{r}
top3_indices
```

A partir de estos datos podemos sacar conclusiones muy interesantes, Chicago City Saddles al principio tiene una participacion muy alta a la hora de comprar, pero con los años ha ido bajando hasta quedarse solo en un 8% cuando el primer año tenian  un 27% del total de compras. Por otro lado tenemos Superior Bicycles y Professional Athletic Consultants, que recordemos que empiezan en 2012 y estan rondando todos los años un 15% y un 10% respectivamente manteniendose estables. 

Eso si , las compras en general han tenido un crecimiento exponencial , lo cual indica que la empresa funciona muy bien y tiene pinta que lo va a seguir haciendo , aunque tengamos en cuenta que en este ultimo año solo tenemos  datos hasta agosto , el crecimiento es menor respecto al de 2013, los cuales alcanzan una tasa de crecimiento de 295.19% para  Chicago City, 596.96% para Superior Bicycles y  433.33% para Professional Athletic Consultants. Ahora en agosto apenas llegan a el 100% por lo que rondaran el 200% a final de año que sigue siendo un crecimiento muy alto.

Por ultimo tenemos el indice base que indica el crecimiento de cada año respecto a el primer año con datos /año base), los datos vienen a decir lo mismo , el crecimiento es muy grande y cada año va a mejor.


# Indicador 2 Comparacion de precios de los precios estandar (precio esperado) con el precio real 




```{r}
comparacion_precios_anual <- detalle %>%
  inner_join(cabecera, by = "PurchaseOrderID") %>%
  inner_join(proveedor, by = "ProductID") %>%
  inner_join(producto, by = "ProductID") %>%
  inner_join(Calendario, by = c("OrderDate" = "Fecha")) %>%
  select(Año, ProductID, ProductName = Name, PrecioReal = UnitPrice, PrecioEstandar = StandardPrice) %>%
  mutate(Diferencia = PrecioReal - PrecioEstandar) %>%
  filter(!is.na(Año)) %>%
  group_by(Año, ProductID, ProductName) %>%
  summarise(DiferenciaPromedio = mean(Diferencia, na.rm = TRUE), .groups = "drop") %>%
  arrange(Año, desc(DiferenciaPromedio))
```

```{r}

top_altas_anual <- comparacion_precios_anual %>%
  group_by(Año) %>%
  slice_max(order_by = DiferenciaPromedio, n = 10) %>%
  ungroup()

top_bajas_anual <- comparacion_precios_anual %>%
  group_by(Año) %>%
  slice_min(order_by = DiferenciaPromedio, n = 10) %>%
  ungroup()
```

```{r}

ggplot(top_altas_anual, aes(x = reorder(ProductName, DiferenciaPromedio), y = DiferenciaPromedio)) +
  geom_bar(stat = "identity", fill = "darkred") +
  facet_wrap(~ Año, scales = "free_y") +
  labs(
    title = "Top Productos con precio real muy Superior al estándar por año",
    x = "Producto",
    y = "Diferencia Promedio"
  ) +
  coord_flip() +
  theme_minimal()

ggplot(top_bajas_anual, aes(x = reorder(ProductName, DiferenciaPromedio), y = DiferenciaPromedio)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  facet_wrap(~ Año, scales = "free_y") +
  labs(
    title = "Top Productos con precio real muy inferior al estándar por año",
    x = "Producto",
    y = "Diferencia Promedio"
  ) +
  coord_flip() +
  theme_minimal()
```


La conclusion principal que podemos sacar es que tanto como los pedales como los frenos los estamos comprando todos los años a un precio mayor del esperado, esto puede deberse a que el precio esperado esta mal calculado o estamos pagando mas de lo que deberiamos en estas compras. Tambien que en el ultimo año es cuando podemos observar unos mayores  cambios entre los precios esperados y los precios reales, sacar indices a partir de esta informacion es complejo ya que la mayoria de productos tienen la misma diferencia todos los años por lo que es siempre igual.
